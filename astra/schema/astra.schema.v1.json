{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/astra/astra.schema.v1.json",
  "title": "Astra Module Schema v1.0",
  "description": "JSON-AST schema for the Astra LLM-first programming language (v1.0).",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "module",
    "functions",
    "version"
  ],
  "properties": {
    "module": {
      "$ref": "#/$defs/QualifiedName"
    },
    "version": {
      "type": "string",
      "enum": [
        "1.0"
      ]
    },
    "functions": {
      "type": "array",
      "minItems": 0,
      "items": {
        "$ref": "#/$defs/FunctionDef"
      }
    },
    "tests": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/TestCase"
      }
    },
    "metadata": {
      "type": "object"
    },
    "imports": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "externs": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "properties": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/PropertyTest"
      }
    }
  },
  "$defs": {
    "Identifier": {
      "type": "string",
      "pattern": "^[A-Za-z_][A-Za-z0-9_]*$",
      "description": "A simple identifier."
    },
    "QualifiedName": {
      "type": "string",
      "pattern": "^[A-Za-z_][A-Za-z0-9_]*(\\.[A-Za-z_][A-Za-z0-9_]*)*$",
      "description": "A dot-separated qualified name (e.g., my_mod.fn)."
    },
    "EffectName": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*(\\.[a-z][a-z0-9_]*)*$",
      "description": "Effect/capability name (e.g., pure, fs.read, net.http)."
    },
    "VarExpr": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "var"
      ],
      "properties": {
        "var": {
          "$ref": "#/$defs/Identifier"
        }
      }
    },
    "CallExpr": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "call"
      ],
      "properties": {
        "call": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "fn",
            "args"
          ],
          "properties": {
            "fn": {
              "$ref": "#/$defs/QualifiedName"
            },
            "args": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/Expr"
              }
            }
          }
        }
      }
    },
    "ListExpr": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "list"
      ],
      "properties": {
        "list": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Expr"
          }
        }
      }
    },
    "ObjExpr": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "obj"
      ],
      "properties": {
        "obj": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/Expr"
          }
        }
      }
    },
    "Expr": {
      "description": "An expression node. Literals are represented as plain JSON scalars (number/string/bool/null).",
      "oneOf": [
        {
          "type": "number"
        },
        {
          "type": "string"
        },
        {
          "type": "boolean"
        },
        {
          "type": "null"
        },
        {
          "$ref": "#/$defs/VarExpr"
        },
        {
          "$ref": "#/$defs/CallExpr"
        },
        {
          "$ref": "#/$defs/ListExpr"
        },
        {
          "$ref": "#/$defs/ObjExpr"
        }
      ]
    },
    "LetStmt": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "let"
      ],
      "properties": {
        "let": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "name",
            "expr"
          ],
          "properties": {
            "name": {
              "$ref": "#/$defs/Identifier"
            },
            "expr": {
              "$ref": "#/$defs/Expr"
            }
          }
        }
      }
    },
    "IfStmt": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "if"
      ],
      "properties": {
        "if": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "cond",
            "then",
            "else"
          ],
          "properties": {
            "cond": {
              "$ref": "#/$defs/Expr"
            },
            "then": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/Stmt"
              }
            },
            "else": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/Stmt"
              }
            }
          }
        }
      }
    },
    "ReturnStmt": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "return"
      ],
      "properties": {
        "return": {
          "oneOf": [
            {
              "$ref": "#/$defs/Expr"
            },
            {
              "type": "null"
            }
          ]
        }
      }
    },
    "AssertStmt": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "assert"
      ],
      "properties": {
        "assert": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "expr"
          ],
          "properties": {
            "expr": {
              "$ref": "#/$defs/Expr"
            },
            "message": {
              "type": "string"
            }
          }
        }
      }
    },
    "ExprStmt": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "expr"
      ],
      "properties": {
        "expr": {
          "$ref": "#/$defs/Expr"
        }
      }
    },
    "Stmt": {
      "description": "A statement node.",
      "oneOf": [
        {
          "$ref": "#/$defs/LetStmt"
        },
        {
          "$ref": "#/$defs/IfStmt"
        },
        {
          "$ref": "#/$defs/ReturnStmt"
        },
        {
          "$ref": "#/$defs/AssertStmt"
        },
        {
          "$ref": "#/$defs/ExprStmt"
        }
      ]
    },
    "FunctionDef": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "params",
        "effects",
        "body"
      ],
      "properties": {
        "name": {
          "$ref": "#/$defs/Identifier"
        },
        "doc": {
          "type": "string"
        },
        "params": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Identifier"
          },
          "uniqueItems": true
        },
        "effects": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/EffectName"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "requires": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Expr"
          }
        },
        "ensures": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Expr"
          }
        },
        "body": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Stmt"
          }
        },
        "type_params": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Identifier"
          },
          "description": "Generic type parameters (e.g., ['T','U'])."
        },
        "param_types": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/TypeExpr"
          }
        },
        "returns": {
          "$ref": "#/$defs/TypeExpr"
        },
        "properties": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/PropertyTest"
          }
        },
        "tests": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/TestCase"
          }
        }
      }
    },
    "TestCase": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "fn",
        "args",
        "expect"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "fn": {
          "$ref": "#/$defs/QualifiedName"
        },
        "args": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Expr"
          }
        },
        "expect": {
          "$ref": "#/$defs/Expr"
        }
      }
    },
    "TypeExpr": {
      "type": "string",
      "minLength": 1,
      "description": "Type expression (e.g., Int, List[T], Record{a:Int}, T)."
    },
    "PropertyTest": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "fn",
        "strategy",
        "expect"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "fn": {
          "$ref": "#/$defs/Identifier"
        },
        "strategy": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "cases"
          ],
          "properties": {
            "cases": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100000
            },
            "seed": {
              "type": "integer"
            },
            "max_size": {
              "type": "integer",
              "minimum": 0,
              "maximum": 1000
            }
          }
        },
        "expect": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "post"
          ],
          "properties": {
            "post": {
              "$ref": "#/$defs/Expr",
              "description": "An expression that must evaluate to true; can reference 'result' and params."
            }
          }
        }
      }
    }
  }
}
